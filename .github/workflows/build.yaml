name: Build ArcGIS Pro GeoParquet Add-in

on:
  push:
    branches:
      - main
      - dev  # Test workflow changes on dev branch
    tags:
      - 'v*'  # Production release tags, e.g. v1.0.0
      - 'v*-dev'  # Dev/test release tags, e.g. v0.1.3-dev
  pull_request:
    branches: [ main, dev ]
  workflow_dispatch:  # Allows manual triggering

permissions:
  contents: write  # Needed for creating releases
  
jobs:
  build:
    runs-on: windows-2022  # Using Windows Server 2022 with Visual Studio 2022
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for proper git operations
      
    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v2
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    - name: Update Config.daml version from tag
      if: startsWith(github.ref, 'refs/tags/v')
      shell: powershell
      run: |
        $version = "${{ github.ref }}".Replace('refs/tags/v', '')
        Write-Host "Updating Config.daml to version: $version"

        # Remove -dev suffix for version number in Config.daml
        $cleanVersion = $version -replace '-dev$', ''
        pwsh ./.github/workflows/update-version.ps1 -Version $cleanVersion -ConfigPath "Config.daml"

    - name: Restore NuGet packages
      run: nuget restore DuckDBGeoparquet.sln
      
    - name: Build solution with MSBuild
      run: msbuild DuckDBGeoparquet.sln /p:Configuration=Release /p:Platform="Any CPU"

    - name: Commit version update back to main branch
      if: startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, '-dev')
      shell: bash
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}

        echo "üìù Committing version $VERSION back to main branch..."

        # Configure git with GitHub Actions bot identity
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        # Check if Config.daml has changes
        if git diff --quiet Config.daml; then
          echo "‚ö†Ô∏è  No version changes to commit (Config.daml unchanged)"
          exit 0
        fi

        # Fetch the main branch and switch to it
        git fetch origin main
        git checkout main

        # Add and commit the version update
        git add Config.daml
        git commit -m "chore: bump version to $VERSION [skip ci]

        Automated version update from release tag v$VERSION

        Co-Authored-By: github-actions[bot] <github-actions[bot]@users.noreply.github.com>"

        # Push to main branch
        git push origin main

        echo "‚úÖ Version $VERSION committed back to main branch"

    - name: Get version from tag
      id: get_version
      shell: bash
      run: |
        # Extract version from tag (if present), otherwise use today's date
        if [[ $GITHUB_REF == refs/tags/v* ]]; then
          echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
        else
          echo "VERSION=$(date +'%Y.%m.%d')" >> $GITHUB_OUTPUT
        fi
    
    - name: Create Release Zip
      shell: powershell
      run: |
        $version = "${{ steps.get_version.outputs.VERSION }}"
        $zipName = "ArcGISPro-GeoParquet-Addin-v${version}.zip"
        $addinFile = Get-ChildItem -Path "bin/Release/net8.0-windows" -Filter "*.esriAddInX" | Select-Object -First 1
        
        if ($addinFile) {
          # Create a directory for the release
          New-Item -Path "release" -ItemType Directory -Force
          
          # Create a temporary directory to properly structure the zip content
          $tempDir = "temp-release"
          New-Item -Path $tempDir -ItemType Directory -Force
          
          # Copy the add-in file to the temp directory
          Copy-Item -Path $addinFile.FullName -Destination "$tempDir/"
          
          # Create the zip file containing only the add-in
          Compress-Archive -Path "$tempDir/*" -DestinationPath "release/$zipName" -Force
          
          # Clean up the temporary directory
          Remove-Item -Path $tempDir -Recurse -Force
          
          echo "Created release zip: $zipName containing the .esriAddInX file"
        } else {
          echo "::error::No .esriAddInX file found"
          exit 1
        }
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: addin-package
        path: "bin/Release/net8.0-windows/*.esriAddInX"
        if-no-files-found: error
        
    - name: Upload release zip
      uses: actions/upload-artifact@v4
      with:
        name: release-zip
        path: "release/*.zip"
        if-no-files-found: error
        
    # Create GitHub Release when a production version tag is pushed (not -dev tags)
    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, '-dev')
      uses: softprops/action-gh-release@v2.3.2
      with:
        files: release/*.zip
        name: v${{ steps.get_version.outputs.VERSION }}
        generate_release_notes: true

    # For dev tags, mark as pre-release
    - name: Create GitHub Pre-Release (Dev)
      if: startsWith(github.ref, 'refs/tags/v') && contains(github.ref, '-dev')
      uses: softprops/action-gh-release@v2.3.2
      with:
        files: release/*.zip
        name: v${{ steps.get_version.outputs.VERSION }}
        generate_release_notes: true
        prerelease: true
        draft: false

    # Publish to ArcGIS Online (only for production releases)
    - name: Setup Python
      if: startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, '-dev')
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install arcgis-python-api
      if: startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, '-dev')
      run: pip install arcgis
    
    - name: Publish to ArcGIS Online
      if: startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, '-dev')
      shell: bash
      run: |
        # Find the add-in file
        ADDIN_FILE=$(find bin/Release/net8.0-windows -name "*.esriAddInX" -type f | head -n 1)
        
        if [ -z "$ADDIN_FILE" ]; then
          echo "ERROR: No .esriAddInX file found"
          exit 1
        fi
        
        echo "Found add-in file: $ADDIN_FILE"
        
        # Determine authentication method
        AUTH_ARGS=""
        if [ -n "$AGOL_CLIENT_ID" ] && [ -n "$AGOL_CLIENT_SECRET" ]; then
          echo "‚úÖ Using OAuth2 token authentication"
          AUTH_ARGS="--auth-method token --client-id \"$AGOL_CLIENT_ID\" --client-secret \"$AGOL_CLIENT_SECRET\""
        elif [ -n "$AGOL_USERNAME" ] && [ -n "$AGOL_PASSWORD" ]; then
          echo "‚úÖ Using username/password authentication"
          AUTH_ARGS="--auth-method username --username \"$AGOL_USERNAME\" --password \"$AGOL_PASSWORD\""
        else
          echo "WARNING: No AGOL credentials found. Skipping AGOL publishing."
          echo "Please ensure AGOL_CLIENT_ID and AGOL_CLIENT_SECRET are set in GitHub Secrets"
          exit 0
        fi
        
        # Build command arguments
        CMD_ARGS="--addin-file \"$ADDIN_FILE\" --item-id $AGOL_ITEM_ID"
        
        if [ -n "$AGOL_PORTAL_URL" ]; then
          CMD_ARGS="$CMD_ARGS --portal-url $AGOL_PORTAL_URL"
        fi
        
        if [ -n "$AGOL_TITLE" ]; then
          CMD_ARGS="$CMD_ARGS --title \"$AGOL_TITLE\""
        fi
        
        if [ -n "$AGOL_DESCRIPTION" ]; then
          CMD_ARGS="$CMD_ARGS --description \"$AGOL_DESCRIPTION\""
        fi
        
        if [ -n "$AGOL_TAGS" ]; then
          CMD_ARGS="$CMD_ARGS --tags \"$AGOL_TAGS\""
        fi
        
        # Run the Python script
        python ./.github/workflows/publish-agol.py $AUTH_ARGS $CMD_ARGS
      env:
        AGOL_CLIENT_ID: ${{ secrets.AGOL_CLIENT_ID }}
        AGOL_CLIENT_SECRET: ${{ secrets.AGOL_CLIENT_SECRET }}
        AGOL_USERNAME: ${{ secrets.AGOL_USERNAME }}
        AGOL_PASSWORD: ${{ secrets.AGOL_PASSWORD }}
        AGOL_ITEM_ID: ${{ secrets.AGOL_ITEM_ID }}
        AGOL_PORTAL_URL: ${{ secrets.AGOL_PORTAL_URL }}
        AGOL_TITLE: ${{ secrets.AGOL_TITLE }}
        AGOL_DESCRIPTION: ${{ secrets.AGOL_DESCRIPTION }}
        AGOL_TAGS: ${{ secrets.AGOL_TAGS }}